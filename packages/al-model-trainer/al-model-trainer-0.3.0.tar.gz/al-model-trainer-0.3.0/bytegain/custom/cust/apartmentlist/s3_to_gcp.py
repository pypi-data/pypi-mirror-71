import argparse
import boto3
import botocore
import os
import queue
import threading

from google.cloud import storage

parser = argparse.ArgumentParser()
parser.add_argument('--num_threads', type=int, default=20, help='Number of threads (parallel copies)')
parser.add_argument('--log_type', required=True, help='web or ios or android')
known_args, _ = parser.parse_known_args()

class WorkerThread(threading.Thread):
    def __init__(self, task_queue):
        super(WorkerThread, self).__init__()
        self._task_queue = task_queue
        session = boto3.Session(profile_name='al-s3')
        self._s3_bucket = session.resource('s3').Bucket('al-events')

        self._gcp_client = storage.Client()
        self._bg_dataflow = self._gcp_client.get_bucket('bg-dataflow')

    def run(self):
        ended = False
        while not ended:
            item = self._task_queue.get()
            if not item:
                ended = True
                print('worker exiting')
            else:
                try:
                    self._process(item)
                except Exception as e:
                    print('unexpected exception: ' + str(e))
            self._task_queue.task_done()

    def _process(self, item):
        day, fmeta = item
        fname = os.path.basename(fmeta['Key'])
        blob_name = 'apartmentlist/segment-logs/%s/%s/%s' % (known_args.log_type, day, fname)
        blob = storage.blob.Blob(blob_name, self._bg_dataflow)
        if not blob.exists(self._gcp_client):
            local_fname = 'segment-logs/%s' % fname
            try:
                self._s3_bucket.download_file(fmeta['Key'], local_fname)
            except botocore.exceptions.ClientError as e:
                print('download failed for %s: %s' % (fmeta['Key'], str(e)))
                return
            blob.upload_from_filename(local_fname)
            os.remove(local_fname)
            print('xferred %s' % fname)
        else:
            print('already have %s' % fname)

session = boto3.Session(profile_name='al-s3')
s3c = session.client('s3')
paginator = s3c.get_paginator('list_objects')

task_queue = queue.Queue(100)

web_log_days = [
  1482364800000, 1482451200000, 1482537600000, 1482624000000, 1482710400000, 1482796800000, 1482883200000, 1482969600000,
  1483056000000, 1483142400000, 1483228800000, 1483315200000, 1483401600000, 1483488000000, 1483574400000, 1483660800000,
  1483747200000, 1483833600000, 1483920000000, 1484006400000, 1484092800000, 1484179200000, 1484265600000, 1484352000000,
  1484438400000, 1484524800000, 1484611200000, 1484697600000, 1484784000000, 1484870400000, 1484956800000, 1485043200000,
  1485129600000, 1485216000000, 1485302400000, 1485388800000, 1485475200000, 1485561600000, 1485648000000, 1485734400000,
  1485820800000, 1485907200000, 1485993600000, 1486080000000, 1486166400000, 1486252800000, 1486339200000, 1486425600000,
  1486512000000, 1486598400000, 1486684800000, 1486771200000, 1486857600000, 1486944000000, 1487030400000, 1487116800000,
  1487203200000, 1487289600000, 1487376000000, 1487462400000, 1487548800000, 1487635200000, 1487721600000, 1487808000000,
  1487894400000, 1487980800000, 1488067200000, 1488153600000, 1488240000000, 1488326400000, 1488412800000, 1488499200000,
  1488585600000, 1488672000000, 1488758400000, 1488844800000, 1488931200000, 1489017600000, 1489104000000, 1489190400000,
  1489276800000, 1489363200000, 1489449600000, 1489536000000, 1489622400000, 1489708800000, 1489795200000, 1489881600000,
  1489968000000, 1490054400000, 1490140800000, 1490227200000, 1490313600000, 1490400000000, 1490486400000, 1490572800000,
  1490659200000, 1490745600000, 1490832000000, 1490918400000, 1491004800000, 1491091200000, 1491177600000, 1491264000000,
  1491350400000, 1491436800000, 1491523200000, 1491609600000, 1491696000000, 1491782400000, 1491868800000, 1491955200000,
  1492041600000, 1492128000000, 1492214400000, 1492300800000, 1492387200000, 1492473600000, 1492560000000, 1492646400000,
  1492732800000, 1492819200000, 1492905600000, 1492992000000, 1493078400000, 1493164800000, 1493251200000, 1493337600000,
  1493424000000, 1493510400000, 1493596800000, 1493683200000, 1493769600000, 1493856000000, 1493942400000, 1494028800000,
  1494115200000, 1494201600000, 1494288000000, 1494374400000, 1494460800000, 1494547200000, 1494633600000, 1494720000000,
  1494806400000, 1494892800000, 1494979200000, 1495065600000, 1495152000000, 1495238400000, 1495324800000, 1495411200000,
  1495497600000, 1495584000000, 1495670400000, 1495756800000, 1495843200000, 1495929600000, 1496016000000, 1496102400000,
  1496188800000, 1496275200000, 1496361600000, 1496448000000, 1496534400000, 1496620800000, 1496707200000, 1496793600000,
  1496880000000, 1496966400000, 1497052800000, 1497139200000, 1497225600000, 1497312000000, 1497398400000, 1497484800000,
  1497571200000, 1497657600000, 1497744000000, 1497830400000, 1497916800000, 1498003200000, 1498089600000, 1498176000000,
  1498262400000, 1498348800000, 1498435200000, 1498521600000, 1498608000000, 1498694400000, 1498780800000, 1498867200000,
  1498953600000, 1499040000000, 1499126400000, 1499212800000, 1499299200000, 1499385600000, 1499472000000, 1499558400000,
  1499644800000, 1499731200000, 1499817600000, 1499904000000, 1499990400000, 1500076800000, 1500163200000, 1500249600000,
  1500336000000, 1500422400000, 1500508800000, 1500595200000, 1500681600000, 1500768000000, 1500854400000, 1500940800000,
  1501027200000, 1501113600000, 1501200000000, 1501286400000, 1501372800000, 1501459200000, 1501545600000, 1501632000000,
  1501718400000, 1501804800000, 1501891200000, 1501977600000, 1502064000000, 1502150400000, 1502236800000, 1502323200000,
  1502409600000, 1502496000000, 1502582400000, 1502668800000, 1502755200000, 1502841600000, 1502928000000, 1503014400000,
  1503100800000, 1503187200000, 1503273600000, 1503360000000, 1503446400000, 1503532800000, 1503619200000, 1503705600000,
  1503792000000, 1503878400000, 1503964800000, 1504051200000, 1504137600000, 1504224000000, 1504310400000, 1504396800000,
  1504483200000, 1504569600000, 1504656000000, 1504742400000, 1504828800000, 1504915200000, 1505001600000, 1505088000000,
  1505174400000, 1505260800000, 1505347200000, 1505433600000, 1505520000000, 1505606400000, 1505692800000, 1505779200000,
  1505865600000, 1505952000000, 1506038400000, 1506124800000, 1506211200000, 1506297600000, 1506384000000, 1506470400000,
  1506556800000, 1506643200000, 1506729600000, 1506816000000, 1506902400000, 1506988800000, 1507075200000, 1507161600000,
  1507248000000, 1507334400000, 1507420800000, 1507507200000, 1507593600000, 1507680000000, 1507766400000, 1507852800000,
  1507939200000, 1508025600000, 1508112000000, 1508198400000, 1508284800000, 1508371200000, 1508457600000, 1508544000000,
  1508630400000, 1508716800000, 1508803200000, 1508889600000, 1508976000000, 1509062400000, 1509148800000, 1509235200000,
  1509321600000, 1509408000000, 1509494400000, 1509580800000, 1509667200000, 1509753600000, 1509840000000, 1509926400000,
  1510012800000, 1510099200000, 1510185600000, 1510272000000, 1510358400000, 1510444800000, 1510531200000, 1510617600000,
  1510704000000, 1510790400000, 1510876800000, 1510963200000, 1511049600000, 1511136000000, 1511222400000, 1511308800000,
  1511395200000, 1511481600000, 1511568000000, 1511654400000, 1511740800000, 1511827200000, 1511913600000, 1512000000000,
  1512086400000, 1512172800000, 1512259200000, 1512345600000, 1512432000000, 1512518400000, 1512604800000, 1512691200000,
  1512777600000, 1512864000000, 1512950400000, 1513036800000, 1513123200000, 1513209600000, 1513296000000, 1513382400000,
  1513468800000, 1513555200000, 1513641600000, 1513728000000, 1513814400000, 1513900800000, 1513987200000, 1514073600000,
  1514160000000, 1514246400000, 1514332800000, 1514419200000, 1514505600000, 1514592000000, 1514678400000, 1514764800000,
  1514851200000, 1514937600000, 1515024000000, 1515110400000, 1515196800000, 1515283200000, 1515369600000, 1515456000000,
  1515542400000, 1515628800000, 1515715200000, 1515801600000, 1515888000000, 1515974400000, 1516060800000, 1516147200000,
  1516233600000, 1516320000000, 1516406400000, 1516492800000, 1516579200000, 1516665600000, 1516752000000, 1516838400000,
 ]

ios_log_days = [
 1482969600000, 1483056000000, 1483142400000, 1483228800000, 1483315200000, 1483401600000, 1483488000000, 1483574400000,
 1483660800000, 1483747200000, 1483833600000, 1483920000000, 1484006400000, 1484092800000, 1484179200000, 1484265600000,
 1484352000000, 1484438400000, 1484524800000, 1484611200000, 1484697600000, 1484784000000, 1484870400000, 1484956800000,
 1485043200000, 1485129600000, 1485216000000, 1485302400000, 1485388800000, 1485475200000, 1485561600000, 1485648000000,
 1485734400000, 1485820800000, 1485907200000, 1485993600000, 1486080000000, 1486166400000, 1486252800000, 1486339200000,
 1486425600000, 1486512000000, 1486598400000, 1486684800000, 1486771200000, 1486857600000, 1486944000000, 1487030400000,
 1487116800000, 1487203200000, 1487289600000, 1487376000000, 1487462400000, 1487548800000, 1487635200000, 1487721600000,
 1487808000000, 1487894400000, 1487980800000, 1488067200000, 1488153600000, 1488240000000, 1488326400000, 1488412800000,
 1488499200000, 1488585600000, 1488672000000, 1488758400000, 1488844800000, 1488931200000, 1489017600000, 1489104000000,
 1489190400000, 1489276800000, 1489363200000, 1489449600000, 1489536000000, 1489622400000, 1489708800000, 1489795200000,
 1489881600000, 1489968000000, 1490054400000, 1490140800000, 1490227200000, 1490313600000, 1490400000000, 1490486400000,
 1490572800000, 1490659200000, 1490745600000, 1490832000000, 1490918400000, 1491004800000, 1491091200000, 1491177600000,
 1491264000000, 1491350400000, 1491436800000, 1491523200000, 1491609600000, 1491696000000, 1491782400000, 1491868800000,
 1491955200000, 1492041600000, 1492128000000, 1492214400000, 1492300800000, 1492387200000, 1492473600000, 1492560000000,
 1492646400000, 1492732800000, 1492819200000, 1492905600000, 1492992000000, 1493078400000, 1493164800000, 1493251200000,
 1493337600000, 1493424000000, 1493510400000, 1493596800000, 1493683200000, 1493769600000, 1493856000000, 1493942400000,
 1494028800000, 1494115200000, 1494201600000, 1494288000000, 1494374400000, 1494460800000, 1494547200000, 1494633600000,
 1494720000000, 1494806400000, 1494892800000, 1494979200000, 1495065600000, 1495152000000, 1495238400000, 1495324800000,
 1495411200000, 1495497600000, 1495584000000, 1495670400000, 1495756800000, 1495843200000, 1495929600000, 1496016000000,
 1496102400000, 1496188800000, 1496275200000, 1496361600000, 1496448000000, 1496534400000, 1496620800000, 1496707200000,
 1496793600000, 1496880000000, 1496966400000, 1497052800000, 1497139200000, 1497225600000, 1497312000000, 1497398400000,
 1497484800000, 1497571200000, 1497657600000, 1497744000000, 1497830400000, 1497916800000, 1498003200000, 1498089600000,
 1498176000000, 1498262400000, 1498348800000, 1498435200000, 1498521600000, 1498608000000, 1498694400000, 1498780800000,
 1498867200000, 1498953600000, 1499040000000, 1499126400000, 1499212800000, 1499299200000, 1499385600000, 1499472000000,
 1499558400000, 1499644800000, 1499731200000, 1499817600000, 1499904000000, 1499990400000, 1500076800000, 1500163200000,
 1500249600000, 1500336000000, 1500422400000, 1500508800000, 1500595200000, 1500681600000, 1500768000000, 1500854400000,
 1500940800000, 1501027200000, 1501113600000, 1501200000000, 1501286400000, 1501372800000, 1501459200000, 1501545600000,
 1501632000000, 1501718400000, 1501804800000, 1501891200000, 1501977600000, 1502064000000, 1502150400000, 1502236800000,
 1502323200000, 1502409600000, 1502496000000, 1502582400000, 1502668800000, 1502755200000, 1502841600000, 1502928000000,
 1503014400000, 1503100800000, 1503187200000, 1503273600000, 1503360000000, 1503446400000, 1503532800000, 1503619200000,
 1503705600000, 1503792000000, 1503878400000, 1503964800000, 1504051200000, 1504137600000, 1504224000000, 1504310400000,
 1504396800000, 1504483200000, 1504569600000, 1504656000000, 1504742400000, 1504828800000, 1504915200000, 1505001600000,
 1505088000000, 1505174400000, 1505260800000, 1505347200000, 1505433600000, 1505520000000, 1505606400000, 1505692800000,
 1505779200000, 1505865600000, 1505952000000, 1506038400000, 1506124800000, 1506211200000, 1506297600000, 1506384000000,
 1506470400000, 1506556800000, 1506643200000, 1506729600000, 1506816000000, 1506902400000, 1506988800000, 1507075200000,
 1507161600000, 1507248000000, 1507334400000, 1507420800000, 1507507200000, 1507593600000, 1507680000000, 1507766400000,
 1507852800000, 1507939200000, 1508025600000, 1508112000000, 1508198400000, 1508284800000, 1508371200000, 1508457600000,
 1508544000000, 1508630400000, 1508716800000, 1508803200000, 1508889600000, 1508976000000, 1509062400000, 1509148800000,
 1509235200000, 1509321600000, 1509408000000, 1509494400000, 1509580800000, 1509667200000, 1509753600000, 1509840000000,
 1509926400000, 1510012800000, 1510099200000, 1510185600000, 1510272000000, 1510358400000, 1510444800000, 1510531200000,
 1510617600000, 1510704000000, 1510790400000, 1510876800000, 1510963200000, 1511049600000, 1511136000000, 1511222400000,
 1511308800000, 1511395200000, 1511481600000, 1511568000000, 1511654400000, 1511740800000, 1511827200000, 1511913600000,
 1512000000000, 1512086400000, 1512172800000, 1512259200000, 1512345600000, 1512432000000, 1512518400000, 1512604800000,
 1512691200000, 1512777600000, 1512864000000, 1512950400000, 1513036800000, 1513123200000, 1513209600000, 1513296000000,
 1513382400000, 1513468800000, 1513555200000, 1513641600000, 1513728000000, 1513814400000, 1513900800000, 1513987200000,
 1514073600000, 1514160000000, 1514246400000, 1514332800000, 1514419200000, 1514505600000, 1514592000000, 1514678400000,
]

android_log_days = [
 1491177600000, 1491264000000, 1491350400000, 1491436800000, 1491523200000, 1491609600000, 1491696000000, 1491782400000,
 1491868800000, 1491955200000, 1492041600000, 1492128000000, 1492214400000, 1492300800000, 1492387200000, 1492473600000,
 1492560000000, 1492646400000, 1492732800000, 1492819200000, 1492905600000, 1492992000000, 1493078400000, 1493164800000,
 1493251200000, 1493337600000, 1493424000000, 1493510400000, 1493596800000, 1493683200000, 1493769600000, 1493856000000,
 1493942400000, 1494028800000, 1494115200000, 1494201600000, 1494288000000, 1494374400000, 1494460800000, 1494547200000,
 1494633600000, 1494720000000, 1494806400000, 1494892800000, 1494979200000, 1495065600000, 1495152000000, 1495238400000,
 1495324800000, 1495411200000, 1495497600000, 1495584000000, 1495670400000, 1495756800000, 1495843200000, 1495929600000,
 1496016000000, 1496102400000, 1496188800000, 1496275200000, 1496361600000, 1496448000000, 1496534400000, 1496620800000,
 1496707200000, 1496793600000, 1496880000000, 1496966400000, 1497052800000, 1497139200000, 1497225600000, 1497312000000,
 1497398400000, 1497484800000, 1497571200000, 1497657600000, 1497744000000, 1497830400000, 1497916800000, 1498003200000,
 1498089600000, 1498176000000, 1498262400000, 1498348800000, 1498435200000, 1498521600000, 1498608000000, 1498694400000,
 1498780800000, 1498867200000, 1498953600000, 1499040000000, 1499126400000, 1499212800000, 1499299200000, 1499385600000,
 1499472000000, 1499558400000, 1499644800000, 1499731200000, 1499817600000, 1499904000000, 1499990400000, 1500076800000,
 1500163200000, 1500249600000, 1500336000000, 1500422400000, 1500508800000, 1500595200000, 1500681600000, 1500768000000,
 1500854400000, 1500940800000, 1501027200000, 1501113600000, 1501200000000, 1501286400000, 1501372800000, 1501459200000,
 1501545600000, 1501632000000, 1501718400000, 1501804800000, 1501891200000, 1501977600000, 1502064000000, 1502150400000,
 1502236800000, 1502323200000, 1502409600000, 1502496000000, 1502582400000, 1502668800000, 1502755200000, 1502841600000,
 1502928000000, 1503014400000, 1503100800000, 1503187200000, 1503273600000, 1503360000000, 1503446400000, 1503532800000,
 1503619200000, 1503705600000, 1503792000000, 1503878400000, 1503964800000, 1504051200000, 1504137600000, 1504224000000,
 1504310400000, 1504396800000, 1504483200000, 1504569600000, 1504656000000, 1504742400000, 1504828800000, 1504915200000,
 1505001600000, 1505088000000, 1505174400000, 1505260800000, 1505347200000, 1505433600000, 1505520000000, 1505606400000,
 1505692800000, 1505779200000, 1505865600000, 1505952000000, 1506038400000, 1506124800000, 1506211200000, 1506297600000,
 1506384000000, 1506470400000, 1506556800000, 1506643200000, 1506729600000, 1506816000000, 1506902400000, 1506988800000,
 1507075200000, 1507161600000, 1507248000000, 1507334400000, 1507420800000, 1507507200000, 1507593600000, 1507680000000,
 1507766400000, 1507852800000, 1507939200000, 1508025600000, 1508112000000, 1508198400000, 1508284800000, 1508371200000,
 1508457600000, 1508544000000, 1508630400000, 1508716800000, 1508803200000, 1508889600000, 1508976000000, 1509062400000,
 1509148800000, 1509235200000, 1509321600000, 1509408000000, 1509494400000, 1509580800000, 1509667200000, 1509753600000,
 1509840000000, 1509926400000, 1510012800000, 1510099200000, 1510185600000, 1510272000000, 1510358400000, 1510444800000,
 1510531200000, 1510617600000, 1510704000000, 1510790400000, 1510876800000, 1510963200000, 1511049600000, 1511136000000,
 1511222400000, 1511308800000, 1511395200000, 1511481600000, 1511568000000, 1511654400000, 1511740800000, 1511827200000,
 1511913600000, 1512000000000, 1512086400000, 1512172800000, 1512259200000, 1512345600000, 1512432000000, 1512518400000,
 1512604800000, 1512691200000, 1512777600000, 1512864000000, 1512950400000, 1513036800000, 1513123200000, 1513209600000,
 1513296000000, 1513382400000, 1513468800000, 1513555200000, 1513641600000, 1513728000000, 1513814400000, 1513900800000,
 1513987200000, 1514073600000, 1514160000000, 1514246400000, 1514332800000, 1514419200000, 1514505600000, 1514592000000,
 1514678400000, 1514764800000,
]

days_map = {
 'web': web_log_days,
 'ios': ios_log_days,
 'android': android_log_days,
}

al_schema_map = {
 'web': 'tvlmLRmhza',
 'ios': '1maYRJGQbb',
 'android': 'YxYZwBfbp6',
}

for _ in range(known_args.num_threads):
    thread = WorkerThread(task_queue)
    thread.daemon = True
    thread.start()

for day in days_map[known_args.log_type]:
    page_iterator = paginator.paginate(Bucket='al-events', Prefix='segment-logs/%s/%s/' % (al_schema_map[known_args.log_type], day))
    for page in page_iterator:
        for fmeta in page['Contents']:
            task_queue.put((day, fmeta))
for _ in range(known_args.num_threads):
    task_queue.put(False)
task_queue.join()
