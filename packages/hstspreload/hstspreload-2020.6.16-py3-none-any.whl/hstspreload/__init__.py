"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.6.16"
__checksum__ = "2bf2274e9a294050fcbb11d34e4999cb7f4727c17ccf39cc7187c65449ba1075"
__all__ = ["in_hsts_preload"]

# fmt: off
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 11), (141, 7), (148, 20), (168, 18), None, (186, 22), (208, 45), (253, 7), (260, 9), (269, 36), (305, 10), (315, 10), (325, 21), None, (346, 50), (396, 8), (404, 9), (413, 11), (424, 13), (437, 14), (451, 14), None, None, (465, 29), (494, 16), (510, 35), (545, 14), (559, 24), (583, 9), None, (592, 17), (609, 20), (629, 8), (637, 13), (650, 10), None, (660, 11), (671, 6), (677, 26), (703, 5), (708, 5), (713, 10), (723, 10), (733, 11), (744, 12), (756, 27), None, (783, 11), (794, 5), (799, 7), (806, 29), (835, 18), (853, 27), (880, 46), (926, 25), (951, 16), (967, 8), (975, 5), (980, 22), (1002, 18), None, (1020, 32), (1052, 15), (1067, 8), (1075, 5), None, (1080, 5), (1085, 16), (1101, 14), (1115, 18), None, (1133, 14), (1147, 18), (1165, 48), (1213, 19), (1232, 5), (1237, 46), (1283, 14), (1297, 14), (1311, 20), None, (1331, 6), (1337, 13), (1350, 10), (1360, 19), None, (1379, 13), (1392, 19), (1411, 5), (1416, 4), (1420, 22), (1442, 10), (1452, 7), (1459, 14), (1473, 21), (1494, 11), (1505, 10), (1515, 12), (1527, 32), None, (1559, 10), (1569, 14), (1583, 12), (1595, 45), (1640, 15), None, (1655, 11), (1666, 23), (1689, 21), (1710, 26), (1736, 6), (1742, 6), (1748, 7), (1755, 5), (1760, 20), (1780, 23), (1803, 24), (1827, 13), (1840, 15), (1855, 19), (1874, 6), (1880, 61), (1941, 44), (1985, 12), (1997, 23), (2020, 16), (2036, 38), (2074, 6), (2080, 12), (2092, 44), (2136, 6), (2142, 41), (2183, 13), (2196, 23), (2219, 30), (2249, 16), (2265, 8), (2273, 6), (2279, 12), (2291, 19), (2310, 21), (2331, 15), None, (2346, 35), (2381, 21), (2402, 17), (2419, 19), (2438, 26), (2464, 5), (2469, 37), (2506, 30), (2536, 16), (2552, 10), (2562, 17), (2579, 23), (2602, 14), (2616, 17), (2633, 8), (2641, 4), (2645, 7), (2652, 29), (2681, 6), (2687, 18), (2705, 27), (2732, 20), (2752, 17), (2769, 19), (2788, 12), (2800, 40), (2840, 40), (2880, 12), (2892, 48), (2940, 25), (2965, 12), None, (2977, 8), (2985, 20), (3005, 12), (3017, 6), (3023, 23), None, (3046, 23), (3069, 33), (3102, 14), (3116, 12), (3128, 27), None, (3155, 26), (3181, 31), (3212, 50), (3262, 15), (3277, 20), (3297, 15), (3312, 21), (3333, 32), (3365, 24), (3389, 20), (3409, 13), (3422, 60), (3482, 19), (3501, 9), (3510, 12), (3522, 12), (3534, 11), (3545, 10), (3555, 48), (3603, 32), None, (3635, 25), (3660, 12), None, (3672, 8), (3680, 8), (3688, 7), None, (3695, 25), (3720, 17), None, (3737, 21), (3758, 35), (3793, 12), (3805, 10), (3815, 36), (3851, 20), (3871, 22), (3893, 23), (3916, 19), (3935, 12), (3947, 5), (3952, 30), (3982, 24), (4006, 14), (4020, 14), (4034, 47), (4081, 38), None, None, (4119, 51), (4170, 42), None, (4212, 14), None, (4226, 15), (4241, 8), (4249, 21), (4270, 6), (4276, 16), (4292, 17)], [(4309, 6000), (10309, 6448), (16757, 6827), (23584, 5576), (29160, 6104), (35264, 5655), (40919, 6541), (47460, 5819), (53279, 6461), (59740, 5845), (65585, 6837), (72422, 6079), (78501, 6502), (85003, 6876), (91879, 6340), (98219, 6273), (104492, 6770), (111262, 5788), (117050, 6026), (123076, 6373), (129449, 6631), (136080, 6286), (142366, 6508), (148874, 5868), (154742, 6007), (160749, 6428), (167177, 6310), (173487, 6611), (180098, 6057), (186155, 6221), (192376, 6523), (198899, 6273), (205172, 6203), (211375, 6761), (218136, 5807), (223943, 6640), (230583, 5996), (236579, 6720), (243299, 6362), (249661, 6796), (256457, 7106), (263563, 6052), (269615, 6143), (275758, 5904), (281662, 5877), (287539, 5733), (293272, 6073), (299345, 6730), (306075, 6159), (312234, 5485), (317719, 6199), (323918, 6330), (330248, 6300), (336548, 6523), (343071, 6552), (349623, 6558), (356181, 6569), (362750, 5572), (368322, 6530), (374852, 5584), (380436, 6227), (386663, 6072), (392735, 6120), (398855, 6544), (405399, 6379), (411778, 6366), (418144, 5745), (423889, 6741), (430630, 6379), (437009, 6561), (443570, 6207), (449777, 6197), (455974, 5527), (461501, 6776), (468277, 6671), (474948, 6666), (481614, 5752), (487366, 6916), (494282, 6836), (501118, 5845), (506963, 6455), (513418, 5491), (518909, 6027), (524936, 6281), (531217, 6229), (537446, 6222), (543668, 6404), (550072, 6398), (556470, 6485), (562955, 6198), (569153, 6961), (576114, 5879), (581993, 5970), (587963, 6350), (594313, 6215), (600528, 6716), (607244, 6557), (613801, 6157), (619958, 6065), (626023, 5902), (631925, 5856), (637781, 6547), (644328, 5972), (650300, 6050), (656350, 5848), (662198, 6546), (668744, 6137), (674881, 6595), (681476, 7791), (689267, 6756), (696023, 6666), (702689, 6150), (708839, 6066), (714905, 6426), (721331, 6650), (727981, 6275), (734256, 6022), (740278, 6236), (746514, 6178), (752692, 6667), (759359, 6615), (765974, 6513), (772487, 6865), (779352, 6452), (785804, 7619), (793423, 6170), (799593, 5421), (805014, 6662), (811676, 6437), (818113, 7708), (825821, 6693), (832514, 6006), (838520, 6424), (844944, 6629), (851573, 6103), (857676, 6536), (864212, 5771), (869983, 6528), (876511, 6161), (882672, 6226), (888898, 6235), (895133, 6870), (902003, 6062), (908065, 5991), (914056, 6317), (920373, 6312), (926685, 6187), (932872, 6627), (939499, 5897), (945396, 6794), (952190, 6358), (958548, 6470), (965018, 6512), (971530, 6200), (977730, 6290), (984020, 6165), (990185, 6170), (996355, 6132), (1002487, 5975), (1008462, 5587), (1014049, 5872), (1019921, 6322), (1026243, 6935), (1033178, 5861), (1039039, 6283), (1045322, 6707), (1052029, 6153), (1058182, 5895), (1064077, 6559), (1070636, 6346), (1076982, 5639), (1082621, 6383), (1089004, 7314), (1096318, 5773), (1102091, 5971), (1108062, 6392), (1114454, 6036), (1120490, 6399), (1126889, 6017), (1132906, 5779), (1138685, 7024), (1145709, 6472), (1152181, 6187), (1158368, 6539), (1164907, 7021), (1171928, 6994), (1178922, 5952), (1184874, 6762), (1191636, 6030), (1197666, 6373), (1204039, 6457), (1210496, 5950), (1216446, 6552), (1222998, 6641), (1229639, 6447), (1236086, 6181), (1242267, 6095), (1248362, 6127), (1254489, 6519), (1261008, 5888), (1266896, 6261), (1273157, 5715), (1278872, 6807), (1285679, 6699), (1292378, 6451), (1298829, 6619), (1305448, 5477), (1310925, 6476), (1317401, 6302), (1323703, 6429), (1330132, 6578), (1336710, 6828), (1343538, 6282), (1349820, 6321), (1356141, 6435), (1362576, 6222), (1368798, 6193), (1374991, 6316), (1381307, 6407), (1387714, 6027), (1393741, 6243), (1399984, 5745), (1405729, 6930), (1412659, 6467), (1419126, 6035), (1425161, 6553), (1431714, 6371), (1438085, 5508), (1443593, 6366), (1449959, 6249), (1456208, 7232), (1463440, 6169), (1469609, 5668), (1475277, 6746), (1482023, 6101), (1488124, 6670), (1494794, 5820), (1500614, 5939), (1506553, 5646), (1512199, 6465), (1518664, 6252), (1524916, 6642), (1531558, 6013), (1537571, 6354), (1543925, 6139), (1550064, 6798), (1556862, 6180), (1563042, 5590), (1568632, 6268), (1574900, 6048), (1580948, 6404), (1587352, 6525), (1593877, 6936), (1600813, 6040), (1606853, 6039), (1612892, 6522)], [(1619414, 703), (1620117, 605), (1620722, 605), (1621327, 645), (1621972, 491), (1622463, 579), (1623042, 665), (1623707, 808), (1624515, 652), (1625167, 627), (1625794, 509), (1626303, 508), (1626811, 741), (1627552, 888), (1628440, 902), (1629342, 690), (1630032, 1188), (1631220, 574), (1631794, 804), (1632598, 640), (1633238, 713), (1633951, 688), (1634639, 787), (1635426, 709), (1636135, 684), (1636819, 631), (1637450, 877), (1638327, 1009), (1639336, 746), (1640082, 608), (1640690, 915), (1641605, 743), (1642348, 538), (1642886, 671), (1643557, 712), (1644269, 674), (1644943, 619), (1645562, 656), (1646218, 692), (1646910, 929), (1647839, 683), (1648522, 794), (1649316, 660), (1649976, 651), (1650627, 680), (1651307, 362), (1651669, 763), (1652432, 857), (1653289, 673), (1653962, 499), (1654461, 740), (1655201, 617), (1655818, 750), (1656568, 919), (1657487, 851), (1658338, 464), (1658802, 634), (1659436, 486), (1659922, 614), (1660536, 662), (1661198, 716), (1661914, 707), (1662621, 983), (1663604, 789), (1664393, 555), (1664948, 692), (1665640, 735), (1666375, 447), (1666822, 540), (1667362, 487), (1667849, 653), (1668502, 789), (1669291, 521), (1669812, 706), (1670518, 634), (1671152, 660), (1671812, 530), (1672342, 680), (1673022, 752), (1673774, 428), (1674202, 653), (1674855, 607), (1675462, 828), (1676290, 623), (1676913, 588), (1677501, 282), (1677783, 597), (1678380, 691), (1679071, 741), (1679812, 647), (1680459, 794), (1681253, 1071), (1682324, 772), (1683096, 723), (1683819, 661), (1684480, 419), (1684899, 890), (1685789, 835), (1686624, 564), (1687188, 508), (1687696, 666), (1688362, 843), (1689205, 839), (1690044, 522), (1690566, 632), (1691198, 653), (1691851, 363), (1692214, 467), (1692681, 883), (1693564, 825), (1694389, 792), (1695181, 724), (1695905, 584), (1696489, 749), (1697238, 591), (1697829, 667), (1698496, 650), (1699146, 448), (1699594, 657), (1700251, 563), (1700814, 895), (1701709, 643), (1702352, 762), (1703114, 366), (1703480, 681), (1704161, 656), (1704817, 835), (1705652, 883), (1706535, 761), (1707296, 873), (1708169, 715), (1708884, 502), (1709386, 743), (1710129, 583), (1710712, 737), (1711449, 685), (1712134, 564), (1712698, 682), (1713380, 551), (1713931, 613), (1714544, 594), (1715138, 691), (1715829, 652), (1716481, 676), (1717157, 401), (1717558, 549), (1718107, 641), (1718748, 556), (1719304, 668), (1719972, 594), (1720566, 744), (1721310, 520), (1721830, 478), (1722308, 656), (1722964, 583), (1723547, 607), (1724154, 623), (1724777, 774), (1725551, 594), (1726145, 572), (1726717, 841), (1727558, 798), (1728356, 522), (1728878, 678), (1729556, 767), (1730323, 586), (1730909, 636), (1731545, 459), (1732004, 604), (1732608, 597), (1733205, 714), (1733919, 561), (1734480, 865), (1735345, 658), (1736003, 793), (1736796, 662), (1737458, 606), (1738064, 498), (1738562, 614), (1739176, 699), (1739875, 1263), (1741138, 514), (1741652, 641), (1742293, 608), (1742901, 944), (1743845, 730), (1744575, 716), (1745291, 511), (1745802, 565), (1746367, 808), (1747175, 553), (1747728, 539), (1748267, 826), (1749093, 607), (1749700, 825), (1750525, 746), (1751271, 644), (1751915, 646), (1752561, 822), (1753383, 620), (1754003, 865), (1754868, 616), (1755484, 688), (1756172, 534), (1756706, 689), (1757395, 449), (1757844, 734), (1758578, 709), (1759287, 662), (1759949, 881), (1760830, 753), (1761583, 731), (1762314, 862), (1763176, 972), (1764148, 815), (1764963, 586), (1765549, 839), (1766388, 633), (1767021, 483), (1767504, 443), (1767947, 692), (1768639, 774), (1769413, 387), (1769800, 951), (1770751, 462), (1771213, 718), (1771931, 844), (1772775, 669), (1773444, 769), (1774213, 626), (1774839, 700), (1775539, 665), (1776204, 667), (1776871, 546), (1777417, 566), (1777983, 410), (1778393, 586), (1778979, 437), (1779416, 723), (1780139, 795), (1780934, 722), (1781656, 700), (1782356, 621), (1782977, 568), (1783545, 773), (1784318, 406), (1784724, 457), (1785181, 719), (1785900, 482), (1786382, 788), (1787170, 2071), (1789241, 465), (1789706, 602), (1790308, 875), (1791183, 743), (1791926, 491)], [(1792417, 48), None, (1792465, 35), (1792500, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1792542, 42), None, (1792584, 25), (1792609, 16), None, None, None, None, None, None, (1792625, 26), None, None, None, None, (1792651, 21), (1792672, 25), None, None, (1792697, 26), None, None, None, None, (1792723, 44), (1792767, 21), (1792788, 23), None, None, None, None, (1792811, 48), None, None, None, None, None, (1792859, 31), None, None, None, None, (1792890, 42), None, (1792932, 22), None, (1792954, 21), None, (1792975, 26), (1793001, 42), None, None, (1793043, 77), None, None, None, None, None, (1793120, 21), (1793141, 21), None, None, (1793162, 34), (1793196, 42), None, None, None, (1793238, 25), None, None, (1793263, 21), None, None, None, None, None, (1793284, 24), (1793308, 21), None, None, (1793329, 26), None, (1793355, 18), None, (1793373, 54), None, None, None, None, None, None, (1793427, 26), None, (1793453, 19), None, (1793472, 20), None, None, (1793492, 42), (1793534, 42), (1793576, 17), None, (1793593, 26), None, (1793619, 26), None, None, None, (1793645, 26), (1793671, 20), (1793691, 26), None, (1793717, 42), (1793759, 63), None, None, None, (1793822, 40), None, None, None, None, (1793862, 47), None, None, None, None, None, None, None, (1793909, 42), None, (1793951, 55), None, (1794006, 9), None, (1794015, 21), (1794036, 42), None, None, (1794078, 42), (1794120, 82), None, None, (1794202, 42), None, None, None, None, None, None, None, None, None, (1794244, 42), (1794286, 21), (1794307, 21), None, (1794328, 42), (1794370, 25), None, None, (1794395, 21), (1794416, 42), None, None, (1794458, 21), (1794479, 19), (1794498, 26), None, None, None, (1794524, 21), None, None, (1794545, 38), None, (1794583, 22), (1794605, 21), (1794626, 21), None, None, (1794647, 63), None, (1794710, 21), (1794731, 42), None, (1794773, 17), None, None, None, None, (1794790, 21), (1794811, 21), None, None, (1794832, 21), None, None, (1794853, 21), None, (1794874, 26), None, (1794900, 50), None, None, None, (1794950, 50), (1795000, 26), (1795026, 21), (1795047, 21), (1795068, 19), None, (1795087, 35), (1795122, 26), (1795148, 23), (1795171, 21), (1795192, 42), None, None, None, None, None, None, (1795234, 21), None, None, None, (1795255, 21), None, None, (1795276, 90), None, (1795366, 239), (1795605, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40
_GTLD_INCLUDE_SUBDOMAINS = {
    b"android",
    b"app",
    b"bank",
    b"chrome",
    b"dev",
    b"foo",
    b"gle",
    b"gmail",
    b"google",
    b"hangout",
    b"insurance",
    b"meet",
    b"new",
    b"page",
    b"play",
    b"search",
    b"youtube",
}

try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path), "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
