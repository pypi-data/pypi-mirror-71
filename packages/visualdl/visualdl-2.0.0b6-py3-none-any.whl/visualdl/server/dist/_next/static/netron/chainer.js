var chainer=chainer||{},long=long||{Long:require("long")};chainer.ModelFactory=class{match(e){const t=e.identifier.split(".").pop().toLowerCase();if("npz"===t){const t=e.entries("zip");return t.length>0&&t.every(e=>-1!==e.name.indexOf("/"))}if("h5"===t||"hd5"===t||"hdf5"===t||"keras"===t||"model"===t){const t=e.buffer,r=(e,r,n)=>{for(let i=r;i<=n;i++)if(t.length>i+e.length&&Array.from(e).every((e,r)=>e.charCodeAt(0)===t[i+r]))return!0;return!1};if(r("Â‰HDF\r\n\n",0,0)&&!r("model_config\0",0,2048)&&!r("keras_version\0",0,2048))return!0}return!1}open(e,t){switch(e.identifier.split(".").pop().toLowerCase()){case"npz":return this._openNumPy(e,t);case"h5":case"hd5":case"hdf5":return this._openHdf5(e,t)}}_openNumPy(e,t){const r=e.identifier;return t.require("./numpy").then(n=>t.require("./pickle").then(t=>{try{const r=[],i=new Map,a=new Map,s=new Map;a.set("_codecs.encode",(function(e){return e})),s.set("numpy.core.multiarray._reconstruct",(function(e,t,r){this.subtype=e,this.shape=t,this.dtype=r,this.__setstate__=function(e){this.version=e[0],this.shape=e[1],this.typecode=e[2],this.is_f_order=e[3],this.rawdata=e[4]},this.__read__=function(e){const t={};t.__type__=this.subtype,t.dtype=this.typecode,t.shape=this.shape;let r=t.dtype.itemsize;for(let e=0;e<t.shape.length;e++)r*=t.shape[e];if("string"==typeof this.rawdata){if(t.data=e.unescape(this.rawdata,r),t.data.length!=r)throw new chainer.Error("Invalid string array data size.")}else t.data=this.rawdata,t.data.length;return t}})),s.set("numpy.dtype",(function(e,t,r){switch(e){case"i1":this.name="int8",this.itemsize=1;break;case"i2":this.name="int16",this.itemsize=2;break;case"i4":this.name="int32",this.itemsize=4;break;case"i8":this.name="int64",this.itemsize=8;break;case"u1":this.name="uint8",this.itemsize=1;break;case"u2":this.name="uint16",this.itemsize=2;break;case"u4":this.name="uint32",this.itemsize=4;break;case"u8":this.name="uint64",this.itemsize=8;break;case"f4":this.name="float32",this.itemsize=4;break;case"f8":this.name="float64",this.itemsize=8;break;default:if(e.startsWith("V"))this.itemsize=Number(e.substring(1)),this.name="void"+(8*this.itemsize).toString();else if(e.startsWith("O"))this.itemsize=Number(e.substring(1)),this.name="object";else if(e.startsWith("S"))this.itemsize=Number(e.substring(1)),this.name="string";else if(e.startsWith("U"))this.itemsize=Number(e.substring(1)),this.name="string";else{if(!e.startsWith("M"))throw new chainer.Error("Unknown dtype '"+e.toString()+"'.");this.itemsize=Number(e.substring(1)),this.name="datetime"}}this.align=t,this.copy=r,this.__setstate__=function(e){switch(e.length){case 8:this.version=e[0],this.byteorder=e[1],this.subarray=e[2],this.names=e[3],this.fields=e[4],this.elsize=e[5],this.alignment=e[6],this.int_dtypeflags=e[7];break;default:throw new chainer.Error("Unknown numpy.dtype setstate length '"+e.length.toString()+"'.")}}}));const h=(e,t)=>{if(a.has(e)){return a.get(e).apply(null,t)}const r={__type__:e};if(!s.has(e))throw new chainer.Error("Unknown function '"+e+"'.");s.get(e).apply(r,t);return r},o=new Map([["i1","int8"],["i2","int16"],["i4","int32"],["i8","int64"],["u1","uint8"],["u2","uint16"],["u4","uint32"],["u8","uint64"],["f2","float16"],["f4","float32"],["f8","float64"]]);for(const a of e.entries("zip")){if(!a.name.endsWith(".npy"))throw new chainer.Error("Invalid file name '"+a.name+"'.");const e=a.name.replace(/\.npy$/,"").split("/");if(e.length<2)throw new chainer.Error("Invalid parameter name '"+a.name+"'.");const s=e.pop(),u=e.join("/");if(!i.has(u)){const e={name:u,parameters:[]};r.push(e),i.set(u,e)}const c=i.get(u);let p=new n.Array(a.data);if("|"===p.byteOrder){if("O"!==p.dataType)throw new chainer.Error("Invalid data type '"+p.dataType+"'.");const e=new t.Unpickler(p.data);p={dataType:e.load(h).dtype.name,shape:null,data:null,byteOrder:"|"}}c.parameters.push({name:s,dataType:o.has(p.dataType)?o.get(p.dataType):p.dataType,shape:p.shape,data:p.data,byteOrder:p.byteOrder})}return new chainer.Model(r,"Chainer NumPy")}catch(e){const t=e&&e.message?e.message:e.toString();throw new chainer.Error(t.replace(/\.$/,"")+" in '"+r+"'.")}}))}_openHdf5(e,t){const r=e.identifier;return t.require("./hdf5").then(t=>{try{let r=new t.File(e.buffer).rootGroup;if(0!==Object.keys(r.attributes).length||null!==r.value)throw new chainer.Error("File format is not Chainer HDF5");let n=null;const i=[],a=new Map;if(0===Object.keys(r.attributes).length&&null===r.value&&1==r.groups.length&&r.groups[0]&&0===Object.keys(r.groups[0].attributes).length&&null===r.groups[0].value&&(r=r.groups[0],n="Weights HDF5"),r.groups.every(e=>0===Object.keys(e.attributes).length&&null===e.value)){n=n||"Chainer HDF5";for(const e of r.groups){const t=e.attributes.name||e.name;if(!a.has(t)){const e={name:t,parameters:[]};a.set(t,e),i.push(e)}const r=a.get(t);for(const t of e.groups){if(0!==Object.keys(t.attributes).length||0!==t.groups.length)throw new chainer.Error("Variable format is not Chainer HDF5");const e=t.value;if(!e)throw new chainer.Error("Variable value is not Chainer HDF5");r.parameters.push({name:t.name,dataType:e.type,byteOrder:e.littleEndian?"<":">",shape:e.shape,data:e.data})}}}else{if(!r.groups.every(e=>null===e.value&&e.groups.every(e=>0===Object.keys(e.attributes).length&&null!==e.value)))throw new chainer.Error("Module group format is not Chainer HDF5");n=n||"Weights HDF5";for(const e of r.groups){const t=e.attributes.name||e.name;if(!a.has(t)){const e={name:t,parameters:[]};a.set(t,e),i.push(e)}const r=a.get(t);for(const t of e.groups){if(0!==Object.keys(t.attributes).length||0!==t.groups.length)throw new chainer.Error("Variable format is not Chainer HDF5");const e=t.value;if(!e)throw new chainer.Error("Variable value is not Chainer HDF5");r.parameters.push({name:t.name,dataType:e.type,byteOrder:e.littleEndian?"<":">",shape:e.shape,data:e.data})}}}return new chainer.Model(i,n)}catch(e){const t=e&&e.message?e.message:e.toString();throw new chainer.Error(t.replace(/\.$/,"")+" in '"+r+"'.")}})}},chainer.Model=class{constructor(e,t){this._format=t,this._graphs=[],this._graphs.push(new chainer.Graph(e))}get format(){return this._format}get graphs(){return this._graphs}},chainer.Graph=class{constructor(e){this._nodes=[];for(const t of e)this._nodes.push(new chainer.Node(t))}get inputs(){return[]}get outputs(){return[]}get nodes(){return this._nodes}},chainer.Parameter=class{constructor(e,t){this._name=e,this._arguments=t}get name(){return this._name}get visible(){return!0}get arguments(){return this._arguments}},chainer.Argument=class{constructor(e,t){if("string"!=typeof e)throw new chainer.Error("Invalid argument identifier '"+JSON.stringify(e)+"'.");this._name=e,this._initializer=t||null}get name(){return this._name}get type(){return this._initializer.type}get initializer(){return this._initializer}},chainer.Node=class{constructor(e){this._name=e.name,this._inputs=[];for(const t of e.parameters){const e=[this._name,t.name].join("/"),r=new chainer.Tensor(e,t.dataType,t.shape,t.data,t.byteOrder);this._inputs.push(new chainer.Parameter(t.name,[new chainer.Argument(e,r)]))}}get type(){return"Module"}get name(){return this._name}get metadata(){return null}get inputs(){return this._inputs}get outputs(){return[]}get attributes(){return[]}},chainer.Tensor=class{constructor(e,t,r,n,i){this._name=e,this._type=new chainer.TensorType(t,new chainer.TensorShape(r)),this._shape=r,this._data=n,this._byteOrder=i}get kind(){return""}get name(){return this._name}get type(){return this._type}get state(){return this._context().state}get value(){const e=this._context();return e.state?null:(e.limit=Number.MAX_SAFE_INTEGER,this._decode(e,0))}toString(){const e=this._context();if(e.state)return"";e.limit=1e4;const t=this._decode(e,0);return chainer.Tensor._stringify(t,"","    ")}_context(){const e={index:0,count:0,state:null};if("<"!==this._byteOrder&&">"!==this._byteOrder)return e.state="Tensor byte order is not supported.",e;if(this._reference)return e.state="Tensor reference not implemented.",e;if(!this._data||0==this._data.length)return e.state="Tensor data is empty.",e;switch(this._type.dataType){case"float16":e.itemSize=2;break;case"float32":e.itemSize=4;break;case"float64":e.itemSize=8;break;case"int8":e.itemSize=1;break;case"int16":e.itemSize=2;break;case"int32":e.itemSize=4;break;case"int64":e.itemSize=8;break;case"uint8":e.itemSize=1;break;case"uint16":e.itemSize=2;break;case"uint32":e.itemSize=4;break;default:return e.state="Tensor data type is not supported.",e}return e.dimensions=this._type.shape.dimensions,e.dataType=this._type.dataType,e.littleEndian="<"==this._byteOrder,e.data=this._data,e.rawData=new DataView(this._data.buffer,this._data.byteOffset,this._data.byteLength),e}_decode(e,t){const r=e.littleEndian,n=0==e.dimensions.length?[1]:e.dimensions,i=[],a=n[t];if(t==n.length-1)for(let t=0;t<a;t++){if(e.count>e.limit)return i.push("..."),i;if(e.rawData){switch(e.dataType){case"float16":i.push(e.rawData.getFloat16(e.index,r));break;case"float32":i.push(e.rawData.getFloat32(e.index,r));break;case"float64":i.push(e.rawData.getFloat64(e.index,r));break;case"int8":i.push(e.rawData.getInt8(e.index,r));break;case"int16":i.push(e.rawData.getInt16(e.index,r));break;case"int32":i.push(e.rawData.getInt32(e.index,r));break;case"int64":i.push(long.Long.fromBytes(e.data.subarray(e.index,e.index+8),!0,r));break;case"uint8":i.push(e.rawData.getUint8(e.index,r));break;case"uint16":i.push(e.rawData.getUint16(e.index,r));break;case"uint32":i.push(e.rawData.getUint32(e.index,r))}e.index+=e.itemSize,e.count++}}else for(let r=0;r<a;r++){if(e.count>e.limit)return i.push("..."),i;i.push(this._decode(e,t+1))}return 0==e.dimensions.length?i[0]:i}static _stringify(e,t,r){if(Array.isArray(e)){const n=[];n.push(t+"[");const i=e.map(e=>chainer.Tensor._stringify(e,t+r,r));return i.length>0&&n.push(i.join(",\n")),n.push(t+"]"),n.join("\n")}return"string"==typeof e?t+e:e==1/0?t+"Infinity":e==-1/0?t+"-Infinity":isNaN(e)?t+"NaN":t+e.toString()}},chainer.TensorType=class{constructor(e,t){this._dataType=e,this._shape=t}get dataType(){return this._dataType||"?"}get shape(){return this._shape}toString(){return this.dataType+this._shape.toString()}},chainer.TensorShape=class{constructor(e){this._dimensions=e}get dimensions(){return this._dimensions}toString(){return this._dimensions&&0!=this._dimensions.length?"["+this._dimensions.join(",")+"]":""}},chainer.Error=class extends Error{constructor(e){super(e),this.name="Error loading Chainer model."}},"undefined"!=typeof module&&"object"==typeof module.exports&&(module.exports.ModelFactory=chainer.ModelFactory);